<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель — Avia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
            background: url('/static/images/background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #222
        }

        .navbar-custom {
            background: transparent !important;
            box-shadow: none
        }

        .navbar-brand {
            color: #fff !important;
            font-weight: 700
        }

        .content-card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 14px;
            padding: 28px;
            box-shadow: 0 18px 60px rgba(0, 0, 0, 0.16);
            margin: 0 0px;
            border: 1px solid rgba(255, 255, 255, 0.06)
        }

        h1,
        h2 {
            color: #0b5ed7
        }

        .card {
            box-shadow: 0 8px 26px rgba(0, 0, 0, 0.08);
            border: none
        }

        .content-card .form-control {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 10px;
            height: 46px
        }

        .content-card .table thead th {
            background: linear-gradient(90deg, #1673e6, #0b5ed7);
            color: #fff
        }

        .btn-primary {
            background: linear-gradient(90deg, #1673e6, #0b5ed7);
            border: none;
            border-radius: 10px;
            padding: 8px 14px
        }

        .toast-container {
            position: fixed;
            top: 18px;
            right: 18px;
            z-index: 11000
        }

        /* Charts and stats styling */
        .chart-card {
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.92));
            box-shadow: 0 8px 30px rgba(11, 94, 215, 0.08);
            height: 100%;
            padding: 12px;
            border: 1px solid rgba(11, 94, 215, 0.06);
        }

        #statsSummary {
            border-radius: 10px;
            background: linear-gradient(90deg, rgba(11, 94, 215, 0.06), rgba(11, 94, 215, 0.03));
            color: #0b5ed7;
            padding: 16px;
            min-height: 220px;
        }

        .stat-value {
            font-weight: 700;
            color: #222
        }

        .stat-label {
            color: #6c757d
        }

        @media (max-width:768px) {
            .content-card {
                margin: 12px;
                padding: 18px
            }

            #statsSummary {
                min-height: auto;
                margin-bottom: 12px
            }

            .chart-card {
                height: 220px
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-plane me-2"></i>Avia</a>
            <div class="nav-right">
                <span id="userInfo" class="text-white">Администратор</span>
                <button class="btn btn-outline-danger ms-2 auth-btn-sm" onclick="logout()">Выход <i
                        class="fas fa-sign-out-alt ms-1"></i></button>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="content-card">
            <h1><i class="fas fa-cog me-2"></i>Админ-панель</h1>

            <!-- Управление пользователями -->
            <h2><i class="fas fa-users me-2"></i>Пользователи</h2>
            <div id="usersTable" class="table-responsive mb-5">
                <div class="card">
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Логин</th>
                                    <th>Роль</th>
                                    <th>Заблокирован</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Добавление компании -->
            <h2><i class="fas fa-building me-2"></i>Добавить компанию</h2>
            <div class="card mb-5">
                <div class="card-body">
                    <form id="addCompanyForm" class="row g-3">
                        <div class="col-md-6 col-lg-4">
                            <input type="text" class="form-control" id="name" placeholder="Название компании" required>
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <input type="number" class="form-control" id="manager_id" placeholder="ID менеджера">
                        </div>
                        <div class="col-md-6 col-lg-4">
                            <input type="text" class="form-control" id="company_password"
                                placeholder="Пароль для компании (опционально)">
                        </div>
                        <div class="col-md-12 col-lg-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary"><i
                                    class="fas fa-plus me-2"></i>Добавить</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Статистика платформы -->
            <h2><i class="fas fa-chart-bar me-2"></i>Статистика платформы</h2>
            <div class="card mb-5">
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select id="period" class="form-select">
                                <option value="all">Все время</option>
                                <option value="today">Сегодня</option>
                                <option value="week">Неделя</option>
                                <option value="month">Месяц</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-secondary" onclick="loadStats()"><i
                                    class="fas fa-sync-alt me-2"></i>Обновить</button>
                        </div>
                    </div>
                    <div id="stats" class="row">
                        <div class="col-md-5">
                            <div id="statsSummary" class="alert alert-info">Загрузка статистики...</div>
                        </div>
                        <div class="col-md-7">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="card chart-card" style="height:260px">
                                        <div class="card-body p-2">
                                            <canvas id="chartFlights" style="width:100%;height:220px"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card chart-card" style="height:260px">
                                        <div class="card-body p-2">
                                            <canvas id="chartMetrics" style="width:100%;height:220px"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Список компаний, добавленных админом -->
        <h2 class="mt-4"><i class="fas fa-building me-2"></i>Компании, добавленные через админку</h2>
        <div class="card mb-5">
            <div class="card-body">
                <div id="adminCompaniesTable" class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Менеджер ID</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: generated manager credentials -->
    <div class="modal fade" id="managerCredsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Аккаунт менеджера создан</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Данные для входа менеджера:</p>
                    <p><strong>Логин:</strong> <span id="credUsername"></span></p>
                    <p><strong>Пароль:</strong> <span id="credPassword"></span></p>
                    <p class="small text-muted">Скопируйте данные и передайте менеджеру. Пароль показывается только один
                        раз.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: reveal company password -->
    <div class="modal fade" id="revealPassModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Пароль компании</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Пароль:</p>
                    <p><strong><span id="revealPasswordValue"></span></strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast контейнер для уведомлений -->
    <div class="toast-container">
        <div id="toast" class="toast align-items-center text-white bg-success border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-check-circle me-2"></i><span id="toastMessage"></span>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        if (!token || role !== 'admin') {
            alert('Доступ только для администраторов!');
            window.location.href = '/login';
        } else {
            document.getElementById('userInfo').textContent = `Администратор (${role})`;
        }

        // Функция для показа toast-уведомления
        function showToast(message, type = 'success') {
            const toast = new bootstrap.Toast(document.getElementById('toast'));
            document.getElementById('toastMessage').innerHTML = message;
            document.getElementById('toast').className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
            toast.show();
        }

        // Загрузка пользователей
        async function loadUsers() {
            console.log('Загружаем пользователей...');
            const response = await fetch('http://127.0.0.1:5000/admin/users', { headers: { 'Authorization': `Bearer ${token}` } });
            console.log('Ответ loadUsers:', response.status);
            if (!response.ok) {
                console.log('Ошибка:', await response.json());
                showToast('Ошибка загрузки пользователей', 'danger');
                return;
            }
            const users = await response.json();
            console.log('Пользователи:', users);

            document.querySelector('#usersTable tbody').innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.role}</td>
                    <td>${u.blocked ? 'Да' : 'Нет'}</td>
                    <td>
                        ${u.blocked ? `<button class="btn btn-success btn-sm" onclick="unblockUser(${u.id})"><i class="fas fa-unlock me-1"></i>Разблокировать</button>` : `<button class="btn btn-danger btn-sm" onclick="blockUser(${u.id})"><i class="fas fa-lock me-1"></i>Заблокировать</button>`}
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="text-center">Пользователей нет</td></tr>';
        }

        // Блок пользователя
        async function blockUser(userId) {
            console.log('Блокируем ID:', userId);
            const response = await fetch(`http://127.0.0.1:5000/admin/users/${userId}/block`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            console.log('Ответ block:', response.status);
            const data = await response.json();
            console.log('Данные block:', data);
            showToast(data.message || data.error, data.message ? 'success' : 'danger');
            loadUsers();  // обновить
        }

        // Разблок пользователя
        async function unblockUser(userId) {
            console.log('Разблокируем ID:', userId);
            const response = await fetch(`http://127.0.0.1:5000/admin/users/${userId}/unblock`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            console.log('Ответ unblock:', response.status);
            const data = await response.json();
            console.log('Данные unblock:', data);
            showToast(data.message || data.error, data.message ? 'success' : 'danger');
            loadUsers();  // обновить
        }

        // Добавление компании
        document.getElementById('addCompanyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const manager_id = document.getElementById('manager_id').value ? parseInt(document.getElementById('manager_id').value) : null;
            const company_password = document.getElementById('company_password').value || null;

            console.log('Добавляем компанию:', { name, manager_id });

            const response = await fetch('http://127.0.0.1:5000/admin/companies', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, manager_id, company_password })
            });
            console.log('Ответ addCompany:', response.status);
            const data = await response.json();
            console.log('Данные addCompany:', data);
            showToast(data.message || data.error, data.message ? 'success' : 'danger');
            if (data.manager_username && data.manager_password) {
                // показать модал с данными
                document.getElementById('credUsername').textContent = data.manager_username;
                document.getElementById('credPassword').textContent = data.manager_password;
                const modal = new bootstrap.Modal(document.getElementById('managerCredsModal'));
                modal.show();
            }
            // обновим список компаний, добавленных админом
            loadAdminCompanies();
            e.target.reset();  // очистка
        });

        // Загрузка компаний, созданных админом
        async function loadAdminCompanies() {
            const response = await fetch('http://127.0.0.1:5000/admin/companies', { headers: { 'Authorization': `Bearer ${token}` } });
            if (!response.ok) {
                const err = await response.text().catch(() => null);
                throw new Error(err || `HTTP ${response.status}`);
            }
            const companies = await response.json();
            document.querySelector('#adminCompaniesTable tbody').innerHTML = companies.map(c => `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.name}</td>
                        <td>${c.manager_id || ''}</td>
                        <td>
                            ${c.blocked ? `<button class="btn btn-success btn-sm me-1" onclick="unblockCompany(${c.id})"><i class="fas fa-unlock me-1"></i>Разблокировать</button>` : `<button class="btn btn-danger btn-sm me-1" onclick="blockCompany(${c.id})"><i class="fas fa-lock me-1"></i>Заблокировать</button>`}
                            ${c.encrypted_password ? `<button class="btn btn-sm btn-outline-primary me-1" onclick="revealCompanyPassword(${c.id})">Показать пароль</button>` : ''}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCompany(${c.id})">Удалить</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4" class="text-center">Компаний нет</td></tr>';
        }

        async function revealCompanyPassword(companyId) {
            const response = await fetch(`http://127.0.0.1:5000/admin/companies/${companyId}/reveal`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!response.ok) {
                const err = await response.json().catch(() => ({ error: 'Ошибка' }));
                showToast(err.error || 'Не удалось получить пароль', 'danger');
                return;
            }
            const data = await response.json();
            document.getElementById('revealPasswordValue').textContent = data.password || '';
            const modal = new bootstrap.Modal(document.getElementById('revealPassModal'));
            modal.show();
        }

        // Блокировка компании
        async function blockCompany(companyId) {
            try {
                const response = await fetch(`http://127.0.0.1:5000/admin/companies/${companyId}/block`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch (e) { data = { error: text } }
                console.log('blockCompany', response.status, data);
                if (!response.ok) showToast(data.error || data.message || `Ошибка: ${response.status}`, 'danger');
                else showToast(data.message || 'Компания заблокирована', 'success');
            } catch (err) {
                console.error('blockCompany err', err);
                showToast('Сетевая ошибка при блокировке', 'danger');
            }
            await loadAdminCompanies();
        }

        // Разблокировка компании
        async function unblockCompany(companyId) {
            try {
                const response = await fetch(`http://127.0.0.1:5000/admin/companies/${companyId}/unblock`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch (e) { data = { error: text } }
                console.log('unblockCompany', response.status, data);
                if (!response.ok) showToast(data.error || data.message || `Ошибка: ${response.status}`, 'danger');
                else showToast(data.message || 'Компания разблокирована', 'success');
            } catch (err) {
                console.error('unblockCompany err', err);
                showToast('Сетевая ошибка при разблокировке', 'danger');
            }
            await loadAdminCompanies();
        }

        // Удаление компании
        async function deleteCompany(companyId) {
            if (!confirm('Вы уверены, что хотите удалить компанию? Это действие необратимо.')) return;
            try {
                const response = await fetch(`http://127.0.0.1:5000/admin/companies/${companyId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch (e) { data = { error: text } }
                console.log('deleteCompany', response.status, data);
                if (!response.ok) showToast(data.error || data.message || `Ошибка: ${response.status}`, 'danger');
                else showToast(data.message || 'Компания удалена', 'success');
            } catch (err) {
                console.error('deleteCompany err', err);
                showToast('Сетевая ошибка при удалении', 'danger');
            }
            await loadAdminCompanies();
        }

        // Статистика
        // helpers
        const fmtNumber = (n) => new Intl.NumberFormat('ru-RU').format(n || 0);
        const fmtCurrency = (n) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'EUR', maximumFractionDigits: 2 }).format(n || 0).replace('€', '€');

        // Charts for admin
        let chartFlights = null;
        let chartMetrics = null;

        function createOrUpdateCharts(stats) {
            const other = Math.max(0, stats.total_flights - (stats.upcoming || 0) - (stats.completed || 0));
            const flightsData = [stats.upcoming || 0, stats.completed || 0, other];

            if (!chartFlights) {
                const ctx = document.getElementById('chartFlights').getContext('2d');
                chartFlights = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['Предстоящие', 'Завершённые', 'Прочие'], datasets: [{ data: flightsData, backgroundColor: ['#0b5ed7', '#2db14d', '#6c757d'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmtNumber(ctx.parsed)}` } } } }
                });
            } else {
                chartFlights.data.datasets[0].data = flightsData; chartFlights.update();
            }

            const metricsData = [stats.total_passengers || 0, stats.total_revenue || 0];
            if (!chartMetrics) {
                const ctx2 = document.getElementById('chartMetrics').getContext('2d');
                chartMetrics = new Chart(ctx2, {
                    type: 'bar',
                    data: { labels: ['Пассажиров', 'Выручка'], datasets: [{ label: 'Значение', data: metricsData, backgroundColor: ['#17a2b8', '#ffc107'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => ctx.label === 'Выручка' ? fmtCurrency(ctx.parsed.y) : fmtNumber(ctx.parsed.y) } } }, scales: { y: { beginAtZero: true, ticks: { callback: v => fmtNumber(v) } } } }
                });
            } else {
                chartMetrics.data.datasets[0].data = metricsData; chartMetrics.update();
            }
        }

        async function loadStats() {
            const period = document.getElementById('period').value;
            const response = await fetch(`http://127.0.0.1:5000/admin/stats?period=${period}`, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!response.ok) { showToast('Ошибка загрузки статистики', 'danger'); return; }
            const stats = await response.json();

            document.getElementById('statsSummary').innerHTML = `
                <h5 class="mb-2"><i class="fas fa-chart-bar me-2"></i>Период: <span class="stat-value">${stats.period}</span></h5>
                <div class="mb-2"><div class="stat-label">Всего рейсов</div><div class="stat-value">${fmtNumber(stats.total_flights)}</div></div>
                <div class="mb-2"><div class="stat-label">Предстоящих</div><div class="stat-value">${fmtNumber(stats.upcoming)}</div></div>
                <div class="mb-2"><div class="stat-label">Завершённых</div><div class="stat-value">${fmtNumber(stats.completed)}</div></div>
                <div class="mb-2"><div class="stat-label">Пассажиров</div><div class="stat-value">${fmtNumber(stats.total_passengers)}</div></div>
                <div class="mb-0"><div class="stat-label">Выручка</div><div class="stat-value">${fmtCurrency(stats.total_revenue)}</div></div>
            `;

            createOrUpdateCharts(stats);
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            window.location.href = '/';
        }

        // Загрузка при старте
        loadUsers();
        loadStats();
        // Подгружаем список компаний сразу при открытии страницы
        (async () => {
            try {
                await loadAdminCompanies();
            } catch (err) {
                console.error('Ошибка загрузки компаний', err);
                // если в err.message есть JSON — покажем его, иначе покажем текст
                try {
                    const parsed = JSON.parse(err.message);
                    showToast(parsed.error || parsed.message || 'Не удалось загрузить список компаний', 'danger');
                } catch (e) {
                    showToast(err.message || 'Не удалось загрузить список компаний', 'danger');
                }
            }
        })();
    </script>
</body>

</html>